<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Семинар 10: Сравнение процедур и макросов в Ассемблере</title>
</head>
<body>
<div style="white-space: pre-wrap;">
Приведу здесь два маленьких примера, разделённых на столбики, чтобы сравнить процедуры и макросы:
Эти программы складывают 4 числа и помещают результат в eax.
<table>
<tr>
<td>
<pre><font color="green">; Начало процедуры</font>				
my_proc:
	
	add eax, ebx
	add eax, ecx
	add eax, edx
	ret
<font color="green">; Конец процедуры</font></pre>
</td>
<td>
<pre><font color="green">; Начало макроса</font>
%macro my_macro 4		<font color="green">; 4 - это число параметров в макросе</font>
	mov eax, %1		<font color="green">; к параметрам обращаемся по номеру, после %</font>
	add eax, %2
	add eax, %3
	add eax, %4
%endmacro
<font color="green">; Конец макроса</font></pre>
</td>
</tr>
</table>
<font color="green">-----------------------------------------------------------------------------------------------------------------</font>
<table>
<tr>
<td>
<pre><font color="green">; Вызов процедуры</font>
	<font color="green">; передача параметров через регистры</font>	
	mov eax, 1
	mov ebx, 2
	mov ecx, 3
	mov edx, 4
	<font color="green">; вызов</font>
	call my_proc <font color="green">; вызов процедуры</font>
	<font color="green">; анализ возвращаемого значения</font>
	cmp eax, 10</pre>
</td>
<td>
<pre><font color="green">; Вызов макроса</font>






	my_macro 1, 2, 3, 4		<font color="green">; вызов макроса</font>

 </pre>
</td>
</tr>
</table>
Но давайте посмотрим их листинг:
<ol>
<li>Сначала процедуры:
<tt>nasm -f obj <a href="../Assembler/Windows/NASM32/Programs_libc/funcs/proc.asm" target="_blank">proc.asm</a> -l <a href="../Assembler/Windows/NASM32/Programs_libc/funcs/proc.lst" target="_blank">proc.lst</a></tt>

<tt>     6                                  my_proc:
     7 00000000 01D8                    	add eax, ebx
     8 00000002 01C8                    	add eax, ecx
     9 00000004 01D0                    	add eax, edx
    10 00000006 C3                      	ret
    12
    13                                  global _start
    14                                  _start:
    15                                  	<font color="green">; передача параметров через регистры</font>
    16 00000007 B801000000              	mov eax, 1
    17 0000000C BB02000000              	mov ebx, 2
    18 00000011 B903000000              	mov ecx, 3
    19 00000016 BA04000000              	mov edx, 4
    20 0000001B E8E0FFFFFF              	call my_proc	<font color="green">; вызов процедуры</font>
...</tt>
Обратите внимание, что и для определения процедуры, и для команды её вызова компилятор генерирует машинный код.
</li>
<li>А теперь то же самое для макроса:
<tt>nasm -f obj <a href="../Assembler/Windows/NASM32/Programs_libc/funcs/macr.asm" target="_blank">macr.asm</a> -l <a href="../Assembler/Windows/NASM32/Programs_libc/funcs/macr.lst" target="_blank">macr.lst</a></tt>

<tt>     5                                  %macro my_macro 4			<font color="green">; 4 - это число параметров в макросе</font>
     6                                  	mov eax, %1			<font color="green">; к параметрам обращаемся по номеру, после %</font>
     7                                  	add eax, %2
     8                                  	add eax, %3
     9                                  	add eax, %4
    11                                  %endmacro
<font color="green"><i>Обратите внимание, что ни для макроопределения не сгенерировано ни байта кода,</i></font>
    13
    14                                  global _start
    15                                  _start:
    16                                  	my_macro 1, 2, 3, 4		<font color="green">; вызов макроса</font>
<font color="green"><i>ни для макровызова ни байта кода,</i></font>
    16 00000000 B801000000          &lt;1&gt;  mov eax, %1
    16 00000005 83C002              &lt;1&gt;  add eax, %2
    16 00000008 83C003              &lt;1&gt;  add eax, %3
    16 0000000B 83C004              &lt;1&gt;  add eax, %4</tt>
зато в макрорасширениях (то, что получилось в результате подстановки макроса) будут столько раз встречаться копии этого кода, сколько раз он вызван.
(Здесь &lt;1&gt; означает уровень вложенности. Т.е. если из аналогичного my_second_macro вызовем my_macro, то в листинге на месте макровызова увидим &lt;2&gt;.)
</li>
</ol>
</div>
<div id="comments"></div>
<script src="comments.js"></script>
</body>
</html>
