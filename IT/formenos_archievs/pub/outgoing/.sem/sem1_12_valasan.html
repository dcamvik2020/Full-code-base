<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Valgrind и AddressSanitizer</title>
</head>
<body>
<div style="white-space: pre-wrap;">
Как самостоятельно <b>собрать и запустить свою программу с инструментами поиска ошибок (под Valgrind'ом ИЛИ AddressSanitizer'ом)</b>, аналогично тому, как это делается в EJudge:
<ul>
<li><b>Valgrind:</b>
в простейшем случае надо при запуске на исполнение просто написать <tt>valgrind</tt> перед командой запуска, например, <tt>./test1</tt>,
однако чтобы он не писал лишнего при успешном завершении программы (т.е. когда всё хорошо и ошибок нет), можно добавить ещё ключ <tt>-q</tt>,
но тогда он перестаёт писать про утечки памяти, поэтому надо ещё добавить опцию <tt>--leak-check=full</tt>, т.е. так:
<tt>valgrind -q --leak-check=full ./test1</tt>
Чтобы он указывал не только, где неинициализированная переменная была использована, но и где создана, можно добавить ещё опцию <tt>--track-origins=yes</tt>,
а чтобы вместо адресов писал номера строчек в исходном файле, то скомпилировать надо с отладочной информацией - ключом <tt>-g</tt>.
Итого:

<tt>gcc -g test.c -o test
valgrind -q --track-origins=yes --leak-check=full ./test</tt>
</li>
<li><b>AddressSanitizer (ASan):</b>
Здесь инструментирование кода идёт на этапе компиляции, поэтому компилятору (<tt>gcc</tt> версии &ge; 4.8 или <tt>clang</tt> &ge; 3.1) надо указать опцию <tt>-fsanitize=address</tt>,
также задать уровень оптимизации <tt>-O1</tt> или выше, а чтобы стек не оптимизировался, то ещё и <tt>-fno-omit-frame-pointer</tt>, т.е. так:

<tt>gcc -fsanitize=address -fno-omit-frame-pointer -g -O2 test0.c -o test0
./test0</tt>

Чтобы вместо адресов получить номера строк, нужно добавить дежурную <tt>-g</tt>,
а если это не <tt>clang</tt>, а <tt>gcc</tt>, то при запуске прописать пару переменных окружения и путь к символайзеру (должен быть установлен LLVM):
<tt>ASAN_OPTIONS=symbolize=1 ASAN_SYMBOLIZER_PATH=/usr/bin/llvm-symbolizer ./test0</tt>
</li>
<li>Поскольку оба эти инструмента подменяют <tt>malloc</tt> и <tt>free</tt> своей реализацией и по-разному используют виртуальную память запускаемого процесса,
то они несовместимы, поэтому запускать их одновременно нельзя (но можно последовательно).
</li>
<li>Другие опции, которые я использую, можете посмотреть в моём <a href="../make.tar.gz" target="_blank">чудо-makefile</a>,
который компилирует и запускает вашу программу под Valgrind'ом, AddressSanitizer'ом и моим StyleChecker'ом с теми же опциями, что и в EJudge.
Можете попробовать его на своей локальной Linux-машине (если установите все нужные пакеты) или в VZ-контейнере, который я некоторым раздавал (там уже всё установлено и работает).
</li></ul>
</div>
<div id="comments"></div>
<script src="comments.js"></script>
</body>
</html>
