<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Урок 10: Не хотите perror - всем большого IF'а!</title>
</head>
<body>
<div style="white-space: pre-wrap;">
Тем, кто ещё не спятил, я предлагаю ещё немного макросной магии.
<ol>
<li>Как вы знаете, результаты любых системных вызовов и библиотечных функций надо проверять, не произошла ли ошибка. И простейшая программа копирования файлов будет выглядеть примерно так:

<tt>#include &lt;stdio.h&gt;

int main(void) {
    FILE *input, *output;
    char s[4096];
    if ((input = fopen(<font color="green">"input.txt"</font>, <font color="green">"rt"</font>)) != NULL) {
        if ((output = fopen(<font color="green">"output.txt"</font>, <font color="green">"wt"</font>)) != NULL) {
            while (fgets(s, sizeof s, input))
                fputs(s, output);
            fclose(output);
        } else
            perror(<font color="green">"fopen(output.txt)"</font>);
        fclose(input);
    } else
        perror(<font color="green">"fopen(input.txt)"</font>);
    return 0;
}</tt>

Это я ещё опустил проверку <tt><b>fclose</b>()</tt>. Если вместо <tt><b>fputs</b>()</tt> и <tt><b>fgets</b>()</tt> использовать <tt><b>fwrite</b>()</tt> и <tt><b>fread</b>()</tt> или <tt><b>write</b>()</tt> и <tt><b>read</b>()</tt> соответственно, то, по-хорошему, надо проверять и их тоже.
Поэтому более-менее серьёзная программа на Си, работающая с кучей файлов, блоков памяти, сокетов и других ресурсов (на каждый приходится по хэндлу-дескриптору) превращается в сплошной набор обработчиков ошибок.
Но можно это дело как-то автоматизировать. Например, так. Посмотрим на этот фрагмент:

<tt>    if ((input = fopen(<font color="green">"input.txt"</font>, <font color="green">"rt"</font>)) != NULL) {
        ...
        fclose(input);
    } else
        perror(<font color="green">"fopen(input.txt)"</font>);</tt>

Сгруппируем части, которые мы хотим автоматизировать:

<tt>    if ((input = fopen(<font color="green">"input.txt"</font>, <font color="green">"rt"</font>)) == NULL)
        perror(<font color="green">"fopen(input.txt)"</font>);
    else {
        ...
        fclose(input);
    }</tt>

Теперь первые 3 строчки можно завернуть под какой-нибудь хитрый макрос:

<tt>#define IF(func)         \
    if (!(func))         \
        perror(<font color="green">#func</font>);   \
    else</tt>

Тогда код, копирующий файл, преобразуется к такому виду:

<tt>    IF ((input = fopen(<font color="green">"input.txt"</font>, <font color="green">"rt"</font>)) != NULL) {
        IF ((output = fopen(<font color="green">"output.txt"</font>, <font color="green">"wt"</font>)) != NULL) {
            while (fgets(s, sizeof s, input))
                fputs(s, output);
            IF (fclose(output) != EOF);
        }
        IF (fclose(input) != EOF);
    }</tt>

Жить стало лучше, жить стало веселее. Не так ли?
В случае отсутствия файла на экран будет выдаваться:
<tt><font color="green">(input = fopen("input.txt", "rt")) != NULL</font>: No such file or directory</tt>
Недостаток в том, что в ваш исполняемый код попадают все строчки, которые под <tt>IF</tt>'ом, т.е. <tt><font color="green">"(input = fopen("input.txt", "rt")) != NULL"</font></tt>, что существенно упрощает задачу Взломщику вашей программы.
Можно это дело, конечно, обойти, но это уже далеко за пределами обычной <i><b>чёрной</b> магии</i>.
</li>
<li>Далее, раз пошла такая пьянка © , то можно добавить отладочной информации:

<tt>#define QUOTEME(x) <font color="green">#x</font>
#define _QUOTEME(x) QUOTEME(x)

#define IF(func)         \
    if (!(func))         \
        perror(__FILE__<font color="green">", "</font>_QUOTEME(__LINE__)<font color="green">": "#func</font>);   \
    else                 \</tt>

Будет выводиться имя файла (предопределённое строковое макрозначение <tt>__FILE__</tt>), склеенное со строковой константой <tt><font color="green">", "</font></tt> и номером строчки <tt>__LINE__</tt>. Препроцессорная операция <tt><font color="green">#x</font></tt> оборачивает значение <tt>x</tt> в кавычки, а чтобы в кавычки у нас попало не <tt><font color="green">"__LINE__"</font></tt>, а всё-таки число, надо поиспользовать этот <tt>__LINE__</tt> как-то иначе, кроме как в <tt><font color="green">#x</font></tt>. Для этого и введён дополнительный макрос <tt>_QUOTEME(x)</tt>.
</li>
<li>Развиваем эту идею. Надоел банальный <tt><b>perror</b>()</tt>? Хотите чего-то большего?
Например, вывести всё это дело не на экран, а в файл, да ещё указать точное время-место-пароли-явки? Ну, для начала надо сэмулировать работу <tt><b>perror</b>()</tt>. Для этого используем код ошибки <tt>errno</tt> в качестве индекса в системной таблице описания ошибок, получаем соответствующую строчку с помощью <tt><b>strerror</b>()</tt> и выводим куда надо с помощью <tt><b>fprintf</b>()</tt> (хотя можно и в диалоговое окошко <tt><b>MessageBox</b>()</tt>, если мы в Windows).
Текущее время можно получить с помощью уже известной нам <tt><b>time</b>()</tt>, а сконвертировать его в человеческий вид с помощью <tt><b>localtime</b>()</tt> (описания этих функций смотрите в <tt>man</tt>'е или в других справках).
Демонстрационный итоговый пример <a href="../C2/adv/errlog.c" target="_blank">errlog.c</a> лежит, <a href="../C2/adv" target="_blank">где</a> ему и положено.
</li>
<li>Ну и на посошок. С помощью директив условной компиляции можно творить настоящие чудеса. Например, выводить полную подробную информацию об ошибке только в конфигурации <tt>Debug</tt>, а для <tt>Release</tt> только протоколировать ошибки:

<tt>#ifdef _DEBUG

#define QUOTEME(x) <font color="green">#x</font>
#define _QUOTEME(x) QUOTEME(x)

#define IF(func)         \
    if (!(func))         \
        perror(__FILE__<font color="green">", "</font>_QUOTEME(__LINE__)<font color="green">": "#func</font>); \
    else                 \

#else

#define IF(func)         \
    if (!(func))         \
        errorlog(<font color="green">""</font>);    \
    else                 \

#endif</tt>

Дальше всё зависит от вашей фантазии и от того, что вам нужно.
</li>
</ol>
</div>
<div id="comments"></div>
<script src="comments.js"></script>
</body>
</html>
